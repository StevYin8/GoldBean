# 📸 照片功能闪退修复步骤

## ✅ 问题已诊断

**问题原因**：iOS 应用访问照片库和相机时，必须声明隐私权限，否则会直接崩溃。

**解决方案**：已为您创建了 `Info.plist` 文件，现在需要在 Xcode 中配置。

---

## 🔧 修复步骤（仅需 3 分钟）

### 步骤 1：在 Xcode 中添加 Info.plist 文件

1. **打开 Xcode 项目**
   ```bash
   # 在当前目录执行：
   open GoldBean.xcodeproj
   ```

2. **将 Info.plist 添加到项目**
   - 在 Xcode 左侧项目导航栏中
   - 找到 `GoldBean` 文件夹（黄色文件夹图标）
   - **右键点击** `GoldBean` 文件夹
   - 选择 `Add Files to "GoldBean"...`
   - 找到并选择 `GoldBean/Info.plist` 文件
   - ✅ 确保勾选 `Copy items if needed`
   - ✅ 确保勾选 `GoldBean` target
   - 点击 `Add`

### 步骤 2：配置项目使用 Info.plist

1. **打开项目设置**
   - 点击 Xcode 左上角的 `GoldBean` 项目（蓝色图标）
   - 在中间区域选择 `TARGETS` 下的 `GoldBean`

2. **设置 Info.plist 路径**
   - 点击顶部的 `Build Settings` 标签
   - 在搜索框中输入 `info.plist`
   - 找到 `Packaging` 部分下的 `Info.plist File`
   - 双击右侧的值，输入：`GoldBean/Info.plist`
   - 按回车确认

### 步骤 3：清理并重新编译

1. **清理构建缓存**
   - 按快捷键 `Shift + Cmd + K`
   - 或菜单栏选择 `Product` > `Clean Build Folder`

2. **重新运行应用**
   - 按快捷键 `Cmd + R`
   - 或点击左上角的 ▶️ 按钮

---

## 🎉 验证修复

运行应用后：

1. **添加新记录**
   - 进入"记录"标签页
   - 点击右上角 `+` 按钮

2. **点击"添加照片"**
   - 向下滚动到"照片"部分
   - 点击"添加照片"按钮
   - ⚠️ **第一次会弹出权限请求对话框**

3. **允许权限**
   - 点击"允许访问所有照片"或"允许访问选中的照片"
   - 再次点击"添加照片"
   - 选择"拍照"或"从相册选择"
   - ✅ **应用不再闪退！**

---

## 📝 Info.plist 中添加的权限说明

已经为您配置了以下三个权限：

| 权限 Key | 说明 | 用途 |
|---------|------|------|
| `NSPhotoLibraryUsageDescription` | 照片库访问权限 | 从相册选择照片 |
| `NSCameraUsageDescription` | 相机使用权限 | 拍摄新照片 |
| `NSPhotoLibraryAddUsageDescription` | 照片库添加权限 | 保存照片到相册 |

系统会向用户显示这些权限描述：
- 📸 "需要访问您的照片库以保存和查看黄金饰品照片"
- 📷 "需要使用相机拍摄黄金饰品照片"

---

## ⚠️ 常见问题

### Q1: 添加 Info.plist 后仍然闪退？

**解决方案**：
1. 确认 Info.plist 文件已正确添加到项目（在 Xcode 左侧可以看到）
2. 检查 Build Settings 中的 Info.plist File 路径是否正确
3. 完全卸载应用后重新安装：
   - 长按应用图标 > 删除 App
   - 在 Xcode 中重新运行 `Cmd + R`

### Q2: 找不到 Info.plist File 设置项？

**解决方案**：
1. 在 Build Settings 搜索框中输入 `info`
2. 确保选择了 `All` 而不是 `Basic`
3. 在 `Packaging` 分组下找到该选项

### Q3: 权限对话框没有弹出？

**解决方案**：
1. 前往 iOS 设置 > 隐私与安全 > 照片
2. 找到 GoldBean 应用
3. 重置权限或手动授予权限

### Q4: 如何更改权限描述文字？

编辑 `GoldBean/Info.plist` 文件，修改对应的 `<string>` 值即可。

---

## 🔍 验证清单

完成修复后，请验证以下功能：

- [ ] 应用正常启动，不闪退
- [ ] 点击"添加照片"，显示权限请求对话框（仅第一次）
- [ ] 允许权限后，可以选择"拍照"
- [ ] 允许权限后，可以选择"从相册选择"
- [ ] 选择照片后，照片正确显示
- [ ] 可以保存带照片的黄金记录
- [ ] 可以查看已保存的照片
- [ ] 可以移除或更换照片
- [ ] 编辑记录时照片功能正常

---

## 📱 用户体验说明

### 权限流程

1. **首次使用**
   - 用户点击"添加照片"
   - 系统弹出权限请求
   - 用户选择允许程度（全部/选中的照片）

2. **后续使用**
   - 无需再次请求权限
   - 直接显示照片选择界面

3. **拒绝权限后**
   - 应用仍可正常使用
   - 只是照片功能不可用
   - 用户可在系统设置中修改权限

---

## 💡 技术细节

### ImagePicker 实现

应用使用 `UIImagePickerController` 实现照片选择功能：
- ✅ 支持从相册选择
- ✅ 支持相机拍摄
- ✅ 支持图片编辑
- ✅ 全屏查看功能
- ✅ 图片自动压缩（JPEG 80% 质量）

### 图片存储

- 图片以 JPEG 格式压缩后存储在 Core Data 中
- 压缩质量：80%（平衡质量和存储空间）
- 存储字段：`imageData: Data?`
- 自动转换：UIImage ↔ Data

---

## 🎯 预期效果

修复完成后：

✅ **稳定性**
- 不再闪退
- 正常请求权限
- 优雅处理权限拒绝

✅ **功能完整**
- 拍照功能正常
- 相册选择正常
- 图片保存和显示正常

✅ **用户体验**
- 权限描述清晰
- 操作流程顺畅
- 界面友好美观

---

如有任何问题，请查看 Xcode 控制台的错误信息，或参考 `PHOTO_PERMISSION_FIX.md` 文档。




